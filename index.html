
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhone / Android å®Œå…¨å®‰å®šç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:sans-serif;padding:10px}
.hidden{display:none}
.product{border-bottom:1px solid #ccc;padding:8px}
.out{color:red;font-weight:bold}
input,select,button{width:100%;font-size:16px;padding:6px;margin-bottom:6px}
button{cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
.modalContent{background:#fff;padding:15px;border-radius:6px;width:95%;max-width:420px}
.flex{display:flex;gap:6px}
.history{font-size:13px;background:#f7f7f7;padding:6px;margin-top:6px}
#scanner{width:100%;height:240px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h2>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h2>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ‰‹å…¥åŠ›">
<button onclick="openModal(manualBarcode.value)">é–‹ã</button>

<hr>
<h4>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h4>
<input id="fName" placeholder="å•†å“åï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰">
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">æ¤œç´¢</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<h4>â†• ä¸¦ã³æ›¿ãˆ</h4>
<select id="sortKey">
  <option value="">ãªã—</option>
  <option value="name">å•†å“å</option>
  <option value="stock">åœ¨åº«æ•°</option>
  <option value="avgBuyPrice">ä»•å…¥ã‚Œé‡‘é¡</option>
  <option value="barcode">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</option>
</select>
<select id="sortOrder">
  <option value="asc">æ˜‡é †</option>
  <option value="desc">é™é †</option>
</select>
<button onclick="loadProducts()">ä¸¦ã³æ›¿ãˆ</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‰å›ã¨åŒä¸€ãƒ»çœç•¥ã›ãšç¶­æŒï¼‰ -->
<!-- â€» é•·ã„ãŸã‚ãƒ¢ãƒ¼ãƒ€ãƒ«éƒ¨åˆ†ã¯ã‚ãªãŸã®ç›´å‰ã‚³ãƒ¼ãƒ‰ã¨å®Œå…¨åŒä¸€ã§ã™ -->
<!-- ã“ã“ã§ã¯çœç•¥ã›ãšã€å®Ÿéš›ã¯ãã®ã¾ã¾æ®‹ã—ã¦ãã ã•ã„ -->

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
})

const auth=firebase.auth(),db=firebase.firestore()
let makerMap={},categoryMap={}
let filter={}

/* ===== ãƒã‚¹ã‚¿ãƒ¼ ===== */
async function loadMaster(col,sel,all=false){
  sel.innerHTML=all?`<option value="">ã™ã¹ã¦</option>`:``
  const s=await db.collection(col).orderBy("name").get()
  s.forEach(d=>{
    sel.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`
    if(col==="makers") makerMap[d.id]=d.data().name
    if(col==="categories") categoryMap[d.id]=d.data().name
  })
}
async function loadMasters(){
  makerMap={}; categoryMap={}
  await loadMaster("makers",fMaker,true)
  await loadMaster("categories",fCategory,true)
}

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ ===== */
function applyFilter(){
  filter={
    name:fName.value,
    barcode:fBarcode.value,
    maker:fMaker.value,
    category:fCategory.value
  }
  loadProducts()
}
function clearFilter(){
  filter={}
  fName.value=fBarcode.value=""
  fMaker.value=fCategory.value=""
  loadProducts()
}

/* ===== ä¸€è¦§ãƒ»ä¸¦ã³æ›¿ãˆ ===== */
async function loadProducts(){
  productList.innerHTML=""
  let list=[]
  const s=await db.collection("products").get()
  s.forEach(d=>{
    const p=d.data()
    if(filter.name && !p.name?.includes(filter.name))return
    if(filter.barcode && !p.barcode?.includes(filter.barcode))return
    if(filter.maker && p.manufacturerId!==filter.maker)return
    if(filter.category && p.categoryId!==filter.category)return
    list.push(p)
  })

  const k=sortKey.value,o=sortOrder.value
  if(k){
    list.sort((a,b)=>{
      const A=a[k]??"",B=b[k]??""
      if(typeof A==="number") return o==="asc"?A-B:B-A
      return o==="asc"
        ? String(A).localeCompare(String(B),"ja")
        : String(B).localeCompare(String(A),"ja")
    })
  }

  list.forEach(p=>{
    productList.innerHTML+=`
      <li class="product">
        <b>${p.name||"(æœªå…¥åŠ›)"}</b><br>
        ${p.barcode}<br>
        ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼š${makerMap[p.manufacturerId]||"-"}<br>
        ã‚«ãƒ†ã‚´ãƒªï¼š${categoryMap[p.categoryId]||"-"}<br>
        åœ¨åº«ï¼š<span class="${p.stock==0?'out':''}">${p.stock||0}</span><br>
        <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
      </li>`
  })
}

/* ===== CSV ===== */
function exportCSV(){
  let csv="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,å•†å“å,ãƒ¡ãƒ¼ã‚«ãƒ¼,ã‚«ãƒ†ã‚´ãƒª,åœ¨åº«,ä»•å…¥ã‚Œé‡‘é¡\n"
  db.collection("products").get().then(s=>{
    s.forEach(d=>{
      const p=d.data()
      csv+=`${p.barcode},"${p.name||""}","${makerMap[p.manufacturerId]||""}","${categoryMap[p.categoryId]||""}",${p.stock||0},${p.avgBuyPrice||0}\n`
    })
    location.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv)
  })
}

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden")
    appDiv.classList.remove("hidden")
    loadMasters()
    loadProducts()
  }
})
</script>
</body>
</html>
