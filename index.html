
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhone / Android å®Œå…¨ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, button {
  width:100%; font-size:16px; padding:6px; margin-bottom:6px;
}
button { cursor:pointer; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.history { font-size:13px; background:#f7f7f7; padding:6px; margin-top:8px; }
#scanner { width:100%; height:240px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<button onclick="openModal(manualBarcode.value)">é–‹ã</button>

<hr>
<ul id="productList"></ul>
</div>

<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>

<input id="modalName" placeholder="å•†å“å">

<!-- è¿½åŠ ï¼šè²©å£²ä¾¡æ ¼ -->
<input id="modalSellPrice" type="number" placeholder="è²©å£²ä¾¡æ ¼">

<input id="modalBuyPrice" type="number" placeholder="ä»•å…¥å˜ä¾¡">
<input id="modalVendor" placeholder="å•å±‹å">

<input id="modalQty" type="number" min="1" value="1">
<button onclick="submitStock('in')">ä»•å…¥</button>
<button onclick="submitStock('out')">è²©å£²</button>

<button onclick="closeModal()">é–‰ã˜ã‚‹</button>

<h4>ğŸ“¦ ä»•å…¥ã‚Œå±¥æ­´ï¼ˆå®‰ã„é †ï¼‰</h4>
<div id="purchaseHistory" class="history"></div>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});

const auth=firebase.auth();
const db=firebase.firestore();
let currentBarcode=null;

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function signup(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function logout(){auth.signOut();}

/* ã‚¹ã‚­ãƒ£ãƒ³ */
function startScan(){
  Quagga.init({
    inputStream:{type:"LiveStream",target:scanner,constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader","code_128_reader"]}
  },()=>{
    Quagga.start();
    Quagga.onDetected(d=>{
      Quagga.stop();
      openModal(d.codeResult.code);
    });
  });
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(barcode){
  if(!barcode) return;
  currentBarcode=barcode;
  modal.style.display="flex";
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼š"+barcode;
  purchaseHistory.innerHTML="";

  const ref=db.collection("products").doc(barcode);
  const prod=await ref.get();

  if(prod.exists){
    const d=prod.data();
    modalName.value=d.name||"";
    modalBuyPrice.value=d.lastBuyPrice ?? "";
    modalVendor.value=d.lastVendor ?? "";
    modalSellPrice.value=d.sellPrice ?? "";
  }

  try{
    const snap=await ref.collection("purchaseHistory").orderBy("price","asc").get();
    snap.forEach(d=>{
      const x=d.data();
      purchaseHistory.innerHTML+=`${x.vendor}ï¼šÂ¥${x.price} Ã—${x.qty}<br>`;
    });
  }catch{
    const snap=await ref.collection("purchaseHistory").get();
    snap.forEach(d=>{
      const x=d.data();
      purchaseHistory.innerHTML+=`${x.vendor}ï¼šÂ¥${x.price||"-"} Ã—${x.qty}<br>`;
    });
  }
}

function closeModal(){ modal.style.display="none"; }

/* åœ¨åº«å‡¦ç† */
async function submitStock(type){
  const ref=db.collection("products").doc(currentBarcode);

  const buyPrice=Number(modalBuyPrice.value);
  const sellPrice=Number(modalSellPrice.value);
  const vendor=modalVendor.value||"æœªå…¥åŠ›";
  const qty=Number(modalQty.value);

  // å•†å“ãƒã‚¹ã‚¿æ›´æ–°ï¼ˆiPhoneåæ˜ å¯¾ç­–ï¼‰
  await ref.set({
    barcode:currentBarcode,
    name:modalName.value,
    lastBuyPrice:isNaN(buyPrice)?0:buyPrice,
    lastVendor:vendor,
    sellPrice:isNaN(sellPrice)?0:sellPrice
  },{merge:true});

  if(type==="in"){
    await ref.collection("purchaseHistory").add({
      price:isNaN(buyPrice)?0:buyPrice,
      vendor,
      qty,
      time:Date.now()
    });
  }

  closeModal();
}

/* ä¸€è¦§ */
async function loadProducts(){
  productList.innerHTML="";
  const s=await db.collection("products").get();
  s.forEach(d=>{
    const p=d.data();
    productList.innerHTML+=`
      <li class="product">
        ${p.name||"(æœªå…¥åŠ›)"}<br>
        Â¥${p.sellPrice||0}<br>
        <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
      </li>`;
  });
}

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadProducts();
  }
});
</script>
</body>
</html>
