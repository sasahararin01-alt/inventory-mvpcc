
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhoneå®Œå…¨å¯¾å¿œãƒ»å®‰å®šç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, select, button {
  width:100%; font-size:16px; padding:6px; margin-bottom:6px;
}
button { cursor:pointer; }
.flex { display:flex; gap:6px; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.csvBtn { background:#0a7; color:#fff; }
.danger { background:#c00; color:#fff; }
.stockView {
  font-weight:bold;
  margin-bottom:8px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="æ‰‹å‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<button onclick="manualBarcodeSet()">é–‹ã</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>

<p class="stockView">ç¾åœ¨åº«ï¼š<span id="modalStock">0</span></p>

<input id="modalName" placeholder="å•†å“å">

<div class="flex">
<select id="modalMaker"></select>
<button onclick="addMaster('makers')">ï¼‹</button>
<button onclick="editMaster('makers')">âœ</button>
<button class="danger" onclick="deleteMaster('makers')">ğŸ—‘</button>
</div>

<div class="flex">
<select id="modalCategory"></select>
<button onclick="addMaster('categories')">ï¼‹</button>
<button onclick="editMaster('categories')">âœ</button>
<button class="danger" onclick="deleteMaster('categories')">ğŸ—‘</button>
</div>

<input id="modalQty" type="number" min="1" value="1">
<input id="modalPrice" type="number" placeholder="ä»•å…¥ä¾¡æ ¼">
<input id="modalRetail" type="number" placeholder="è²©å£²ä¾¡æ ¼">

<button onclick="saveOnly()">ä¿å­˜</button>
<button onclick="submitModal('in')">ä»•å…¥</button>
<button onclick="submitModal('out')">è²©å£²</button>
<button class="danger" onclick="deleteProduct()">å•†å“å‰Šé™¤</button>
<button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentBarcode=null;

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function signup(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function logout(){auth.signOut();}

/* ãƒã‚¹ã‚¿ãƒ¼ */
async function loadMaster(col, sel){
  sel.innerHTML="";
  const s=await db.collection(col).orderBy("name").get();
  s.forEach(d=>{
    const n=d.data().name;
    sel.innerHTML+=`<option value="${n}">${n}</option>`;
  });
}
function loadMasters(){
  loadMaster("makers",modalMaker);
  loadMaster("categories",modalCategory);
}
function addMaster(col){
  const n=prompt("è¿½åŠ ã™ã‚‹åå‰");
  if(n) db.collection(col).add({name:n}).then(loadMasters);
}
function editMaster(col){
  const before=prompt("å¤‰æ›´å‰ã®åå‰");
  const after=prompt("å¤‰æ›´å¾Œã®åå‰");
  if(!before||!after) return;
  db.collection(col).where("name","==",before).get().then(s=>{
    s.forEach(d=>d.ref.update({name:after}));
  }).then(loadMasters);
}
function deleteMaster(col){
  const n=prompt("å‰Šé™¤ã™ã‚‹åå‰");
  if(!n || !confirm(`ã€Œ${n}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  db.collection(col).where("name","==",n).get().then(s=>{
    s.forEach(d=>d.ref.delete());
  }).then(loadMasters);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(barcode){
  currentBarcode=barcode;
  modal.style.display="flex";
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+barcode;
  modalStock.textContent="0";
  modalName.value=""; modalQty.value=1; modalPrice.value=""; modalRetail.value="";
  await loadMasters();
  const s=await db.collection("products").doc(barcode).get();
  if(s.exists){
    const p=s.data();
    modalName.value=p.name||"";
    modalMaker.value=p.manufacturer||"";
    modalCategory.value=p.category||"";
    modalPrice.value=p.latestPrice||"";
    modalRetail.value=p.retailPrice||"";
    modalStock.textContent=p.stock||0;
  }
}
function closeModal(){ modal.style.display="none"; currentBarcode=null; }

/* ä¿å­˜ãƒ»å…¥å‡ºåº« */
async function saveOnly(){
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    latestPrice:+modalPrice.value||0,
    retailPrice:+modalRetail.value||0
  },{merge:true});
  loadProducts(); closeModal();
}
async function submitModal(type){
  const ref=db.collection("products").doc(currentBarcode);
  const s=await ref.get();
  let stock=s.exists?(s.data().stock||0):0;
  const q=+modalQty.value||0;
  if(type==="in") stock+=q;
  else if(stock<q) return alert("åœ¨åº«ä¸è¶³");
  else stock-=q;
  await ref.set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    stock,
    latestPrice:+modalPrice.value||0,
    retailPrice:+modalRetail.value||0
  },{merge:true});
  loadProducts(); closeModal();
}
async function deleteProduct(){
  if(confirm("å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    await db.collection("products").doc(currentBarcode).delete();
    loadProducts(); closeModal();
  }
}

/* ä¸€è¦§ */
async function loadProducts(){
  productList.innerHTML="";
  const s=await db.collection("products").get();
  s.forEach(d=>{
    const p=d.data();
    productList.innerHTML+=`
    <li class="product">
      <strong>${p.name||"(æœªå…¥åŠ›)"}</strong><br>
      ${p.barcode}<br>
      ${p.manufacturer||""} / ${p.category||""}<br>
      åœ¨åº«: <span class="${(p.stock||0)===0?'out':''}">${p.stock||0}</span><br>
      <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
    </li>`;
  });
}

/* ã‚¹ã‚­ãƒ£ãƒ³ */
scanBtn.onclick=()=>{
  Quagga.init({inputStream:{type:"LiveStream",target:"#scanner"},decoder:{readers:["ean_reader"]}},()=>{
    Quagga.start();
    Quagga.offDetected();
    Quagga.onDetected(d=>{
      Quagga.stop();
      openModal(d.codeResult.code);
    });
  });
};
function manualBarcodeSet(){
  if(manualBarcode.value) openModal(manualBarcode.value.trim());
  manualBarcode.value="";
}

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadMasters(); loadProducts();
  }
});
</script>
</body>
</html>
