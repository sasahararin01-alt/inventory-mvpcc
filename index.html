
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:sans-serif;padding:10px}
.hidden{display:none}
.product{border-bottom:1px solid #ccc;padding:8px}
.out{color:red;font-weight:bold}
input,select,button{width:100%;font-size:16px;padding:6px;margin-bottom:6px}
button{cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
.modalContent{background:#fff;padding:15px;border-radius:6px;width:95%;max-width:420px}
.flex{display:flex;gap:6px}
.history{font-size:13px;background:#f7f7f7;padding:6px;margin-top:6px}
#scanner{width:100%;height:240px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h2>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h2>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ‰‹å…¥åŠ›">
<button onclick="openModal(manualBarcode.value)">é–‹ã</button>

<hr>
<h4>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h4>
<input id="fName" placeholder="å•†å“å">
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">æ¤œç´¢</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<h4>â†• ä¸¦ã³æ›¿ãˆ</h4>
<select id="sortKey">
  <option value="">ãªã—</option>
  <option value="name">å•†å“å</option>
  <option value="stock">åœ¨åº«æ•°</option>
  <option value="avgBuyPrice">å¹³å‡ä»•å…¥å˜ä¾¡</option>
  <option value="barcode">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</option>
</select>
<select id="sortOrder">
  <option value="asc">æ˜‡é †</option>
  <option value="desc">é™é †</option>
</select>
<button onclick="loadProducts()">ä¸¦ã³æ›¿ãˆ</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>
<p>ç¾åœ¨åº«ï¼š
  <b id="modalStock" class="out"></b>
</p>

<input id="modalName" placeholder="å•†å“å">

<!-- ãƒ¡ãƒ¼ã‚«ãƒ¼ -->
<select id="modalMaker"></select>
<div class="flex">
  <button onclick="editMaster('makers', modalMaker)">âœï¸</button>
  <button onclick="deleteMaster('makers', modalMaker)">ğŸ—‘</button>
</div>
<div class="flex">
  <input id="newMaker" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼è¿½åŠ ">
  <button onclick="addMaster('makers')">ï¼‹</button>
</div>

<!-- ã‚«ãƒ†ã‚´ãƒª -->
<select id="modalCategory"></select>
<div class="flex">
  <button onclick="editMaster('categories', modalCategory)">âœï¸</button>
  <button onclick="deleteMaster('categories', modalCategory)">ğŸ—‘</button>
</div>
<div class="flex">
  <input id="newCategory" placeholder="ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ">
  <button onclick="addMaster('categories')">ï¼‹</button>
</div>

<input id="modalSellPrice" type="number" placeholder="è²©å£²ä¾¡æ ¼">
<input id="modalBuyPrice" type="number" placeholder="ä»Šå›ä»•å…¥ã‚Œå˜ä¾¡">
<p>å¹³å‡ä»•å…¥å˜ä¾¡ï¼š<b id="avgBuy">0</b></p>

<input id="modalVendor" placeholder="ä»Šå›ä»•å…¥ã‚Œå•å±‹">
<input id="modalQty" type="number" min="1" value="1">

<button onclick="saveOnly()">ğŸ’¾ ä¿å­˜</button>
<button onclick="submitStock('in')">ğŸ“¥ ä»•å…¥ã‚Œ</button>
<button onclick="submitStock('out')">ğŸ“¤ è²©å£²</button>
<button onclick="submitStock('use')">ğŸ§´ ä½¿ç”¨</button>
<button onclick="closeModal()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>

<h4>ğŸ“¦ åœ¨åº«å±¥æ­´</h4>
<div id="history" class="history"></div>

<h4>ğŸ’° ä»•å…¥ã‚Œå±¥æ­´</h4>
<div id="purchaseHistory" class="history"></div>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});
const auth=firebase.auth(),db=firebase.firestore();
let currentBarcode=null,filter={};

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(email.value,password.value)}
function signup(){auth.createUserWithEmailAndPassword(email.value,password.value)}
function logout(){auth.signOut()}

/* ã‚¹ã‚­ãƒ£ãƒ³ */
function startScan(){
  scanner.innerHTML=""
  Quagga.init({
    inputStream:{type:"LiveStream",target:scanner,constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader","ean_8_reader","code_128_reader"]}
  },()=>{
    Quagga.start()
    Quagga.onDetected(d=>{
      Quagga.stop()
      openModal(d.codeResult.code)
    })
  })
}

/* ===== ãƒã‚¹ã‚¿ãƒ¼ç®¡ç† ===== */
async function loadMaster(col,sel,all=false){
  sel.innerHTML=all?"<option value=''>ã™ã¹ã¦</option>":""
  const s=await db.collection(col).orderBy("name").get()
  s.forEach(d=>sel.innerHTML+=`<option data-id="${d.id}">${d.data().name}</option>`)
}

async function loadMasters(){
  await loadMaster("makers",modalMaker)
  await loadMaster("categories",modalCategory)
  await loadMaster("makers",fMaker,true)
  await loadMaster("categories",fCategory,true)
}

async function addMaster(col){
  const v=col==="makers"?newMaker.value:newCategory.value
  if(!v)return
  await db.collection(col).add({name:v})
  newMaker.value=newCategory.value=""
  loadMasters()
}

async function editMaster(col,sel){
  const name=sel.value
  if(!name)return
  const n=prompt("æ–°ã—ã„åå‰",name)
  if(!n)return
  const s=await db.collection(col).where("name","==",name).get()
  s.forEach(d=>db.collection(col).doc(d.id).update({name:n}))
  loadMasters()
}

async function deleteMaster(col,sel){
  const name=sel.value
  if(!name)return
  if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return
  const s=await db.collection(col).where("name","==",name).get()
  s.forEach(d=>db.collection(col).doc(d.id).delete())
  loadMasters()
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(barcode){
  if(!barcode)return
  currentBarcode=barcode
  modal.style.display="flex"
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼š"+barcode
  history.innerHTML=purchaseHistory.innerHTML=""
  modalQty.value=1
  await loadMasters()

  const ref=db.collection("products").doc(barcode)
  const s=await ref.get()
  let stock=0
  if(s.exists){
    const p=s.data()
    modalName.value=p.name||""
    modalMaker.value=p.manufacturer||""
    modalCategory.value=p.category||""
    modalSellPrice.value=p.sellPrice||0
    avgBuy.textContent=p.avgBuyPrice||0
    stock=p.stock||0
  }
  modalStock.textContent=stock
  modalStock.className=stock===0?"out":""

  const h=await ref.collection("history").orderBy("time","desc").limit(5).get()
  h.forEach(d=>{
    const x=d.data()
    history.innerHTML+=`${x.type} ${x.qty} (${new Date(x.time).toLocaleString()})<br>`
  })

  const p=await ref.collection("purchaseHistory").get()
  let total=0,cnt=0
  p.forEach(d=>{
    const x=d.data()
    total+=x.price*x.qty
    cnt+=x.qty
    purchaseHistory.innerHTML+=`${x.vendor} Â¥${x.price} Ã—${x.qty}<br>`
  })
  if(cnt>0)avgBuy.textContent=Math.round(total/cnt)
}

function closeModal(){modal.style.display="none"}

/* ä¿å­˜ãƒ»åœ¨åº«å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰ */
async function saveOnly(){
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    sellPrice:+modalSellPrice.value||0
  },{merge:true})
  loadProducts()
}

async function submitStock(type){
  const ref=db.collection("products").doc(currentBarcode)
  const s=await ref.get()
  let stock=s.exists?(s.data().stock||0):0
  const q=+modalQty.value
  if(type!=="in" && stock<q)return alert("åœ¨åº«ä¸è¶³")
  stock+=type==="in"?q:-q

  await ref.set({
    stock,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    sellPrice:+modalSellPrice.value||0
  },{merge:true})

  if(type==="in"){
    await ref.collection("purchaseHistory").add({
      price:+modalBuyPrice.value||0,
      vendor:modalVendor.value||"",
      qty:q,
      time:Date.now()
    })
  }
  loadProducts();closeModal()
}

/* æ¤œç´¢ãƒ»ä¸€è¦§ãƒ»CSVï¼ˆå¤‰æ›´ãªã—ï¼‰ */
function applyFilter(){
  filter={name:fName.value,barcode:fBarcode.value,maker:fMaker.value,category:fCategory.value}
  loadProducts()
}
function clearFilter(){
  filter={}
  fName.value=fBarcode.value=""
  fMaker.value=fCategory.value=""
  loadProducts()
}

async function loadProducts(){
  productList.innerHTML=""
  let list=[]
  const s=await db.collection("products").get()
  s.forEach(d=>{
    const p=d.data()
    if(filter.name && !p.name?.includes(filter.name))return
    if(filter.barcode && !p.barcode?.includes(filter.barcode))return
    if(filter.maker && p.manufacturer!==filter.maker)return
    if(filter.category && p.category!==filter.category)return
    list.push(p)
  })
  list.forEach(p=>{
    productList.innerHTML+=`
      <li class="product">
        <b>${p.name||"(æœªå…¥åŠ›)"}</b><br>
        ${p.barcode}<br>
        åœ¨åº«ï¼š<span class="${p.stock==0?'out':''}">${p.stock||0}</span><br>
        <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
      </li>`
  })
}

function exportCSV(){
  let csv="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,å•†å“å,ãƒ¡ãƒ¼ã‚«ãƒ¼,ã‚«ãƒ†ã‚´ãƒª,åœ¨åº«\n"
  db.collection("products").get().then(s=>{
    s.forEach(d=>{
      const p=d.data()
      csv+=`${p.barcode},"${p.name||""}","${p.manufacturer||""}","${p.category||""}",${p.stock||0}\n`
    })
    location.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv)
  })
}

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden")
    appDiv.classList.remove("hidden")
    loadMasters()
    loadProducts()
  }
})
</script>
</body>
</html>
