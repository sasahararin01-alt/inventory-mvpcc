
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>在庫管理アプリ（iPhone / Android 完全安定版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, select, button {
  width:100%; font-size:16px; padding:6px; margin-bottom:6px;
}
button { cursor:pointer; }
.flex { display:flex; gap:6px; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.csvBtn { background:#0a7; color:#fff; }
.danger { background:#c00; color:#fff; }
.stockView { font-weight:bold; margin-bottom:8px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<h1>在庫管理アプリ</h1>

<div id="loginDiv">
  <input id="email" placeholder="メール">
  <input id="password" type="password" placeholder="パスワード">
  <button id="loginBtn">ログイン</button>
  <button id="signupBtn">新規登録</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="appDiv" class="hidden">
<button id="logoutBtn">ログアウト</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- モーダル -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>商品登録 / 編集</h3>
<p id="modalBarcode"></p>
<p class="stockView">現在庫：<span id="modalStock">0</span></p>

<input id="modalName" placeholder="商品名">
<input id="modalPrice" type="number" placeholder="仕入価格">
<input id="modalRetail" type="number" placeholder="販売価格">
<input id="modalQty" type="number" min="1" value="1">

<button onclick="submitStock('in')">仕入</button>
<button onclick="submitStock('out')">販売</button>
<button onclick="submitStock('use')">使用</button>
<button onclick="saveOnly()">保存</button>

<button class="danger" onclick="deleteProduct()">商品削除</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* DOM */
const $=id=>document.getElementById(id);
const productList=$("productList");

let currentBarcode=null;

/* 認証 */
$("loginBtn").onclick=()=>auth.signInWithEmailAndPassword(email.value,password.value);
$("signupBtn").onclick=()=>auth.createUserWithEmailAndPassword(email.value,password.value);
$("logoutBtn").onclick=()=>auth.signOut();

/* 一覧 */
async function loadProducts(){
  productList.innerHTML="";
  const s=await db.collection("products").get();
  s.forEach(d=>{
    const p=d.data();
    productList.insertAdjacentHTML("beforeend",`
      <li class="product">
        <strong>${p.name||"(未入力)"}</strong><br>
        ${p.barcode}<br>
        在庫：${p.stock||0}<br>
        <button onclick="openModal('${p.barcode}')">編集</button>
      </li>
    `);
  });
}

/* モーダル */
window.openModal = async barcode=>{
  currentBarcode=barcode;
  $("modal").style.display="flex";
  $("modalBarcode").textContent="バーコード："+barcode;

  const doc=await db.collection("products").doc(barcode).get();
  const p=doc.exists?doc.data():{};
  $("modalName").value=p.name||"";
  $("modalPrice").value=p.latestPrice||0;
  $("modalRetail").value=p.retailPrice||0;
  $("modalStock").textContent=p.stock||0;
};

window.closeModal=()=>{
  $("modal").style.display="none";
};

/* 保存のみ */
window.saveOnly=async()=>{
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:$("modalName").value,
    latestPrice:+$("modalPrice").value||0,
    retailPrice:+$("modalRetail").value||0
  },{merge:true});
  loadProducts(); closeModal();
};

/* 在庫処理＋履歴 */
window.submitStock=async type=>{
  const qty=+$("modalQty").value||0;
  if(qty<=0) return alert("数量エラー");

  const ref=db.collection("products").doc(currentBarcode);
  const doc=await ref.get();
  let stock=doc.exists?(doc.data().stock||0):0;
  const before=stock;

  if(type==="in") stock+=qty;
  else{
    if(stock<qty) return alert("在庫不足");
    stock-=qty;
  }

  await ref.set({stock},{merge:true});
  await ref.collection("histories").add({
    type,qty,before,after:stock,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  loadProducts(); closeModal();
};

/* 削除 */
window.deleteProduct=async()=>{
  if(confirm("削除しますか？")){
    await db.collection("products").doc(currentBarcode).delete();
    loadProducts(); closeModal();
  }
};

/* 認証状態 */
auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadProducts();
  }
});
</script>
</body>
</html>
