
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>在庫管理アプリ（iPhone / Android 完全版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, select, button {
  width:100%; font-size:16px; padding:6px; margin-bottom:6px;
}
button { cursor:pointer; }
.flex { display:flex; gap:6px; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.csvBtn { background:#0a7; color:#fff; }
.danger { background:#c00; color:#fff; }
.stockView { font-weight:bold; margin-bottom:8px; }
.history { font-size:13px; background:#f7f7f7; padding:6px; margin-top:8px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<h1>在庫管理アプリ</h1>

<div id="loginDiv">
  <input id="email" placeholder="メール">
  <input id="password" type="password" placeholder="パスワード">
  <button onclick="login()">ログイン</button>
  <button onclick="signup()">新規登録</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ログアウト</button>

<hr>
<input id="manualBarcode" placeholder="バーコード">
<button onclick="openModal(manualBarcode.value)">開く</button>

<hr>
<h3>絞り込み検索</h3>
<input id="fBarcode" placeholder="バーコード">
<input id="fName" placeholder="商品名">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">検索</button>
<button onclick="clearFilter()">解除</button>

<hr>
<h3>並び替え</h3>
<select id="sortKey">
  <option value="">なし</option>
  <option value="name">商品名</option>
  <option value="manufacturer">メーカー</option>
  <option value="category">カテゴリ</option>
  <option value="stock">在庫</option>
</select>
<select id="sortOrder">
  <option value="asc">昇順</option>
  <option value="desc">降順</option>
</select>
<button onclick="loadProducts()">並び替え</button>

<button class="csvBtn" onclick="exportCSV()">CSV出力</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- モーダル -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>商品登録 / 編集</h3>
<p id="modalBarcode"></p>
<p class="stockView">現在庫：<span id="modalStock">0</span></p>

<input id="modalName" placeholder="商品名">
<select id="modalMaker"></select>
<select id="modalCategory"></select>

<input id="modalQty" type="number" min="1" value="1">
<button onclick="submitStock('in')">仕入</button>
<button onclick="submitStock('out')">販売</button>
<button onclick="submitStock('use')">使用</button>

<button onclick="saveOnly()">保存</button>
<button class="danger" onclick="deleteProduct()">削除</button>
<button onclick="closeModal()">閉じる</button>

<div id="history" class="history"></div>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});
const auth=firebase.auth();
const db=firebase.firestore();

let currentBarcode=null;
let products=[];
let filter={};

/* 認証 */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function signup(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function logout(){auth.signOut();}

/* マスター */
async function loadMaster(col, sel, all=false){
  sel.innerHTML=all?"<option value=''>すべて</option>":"";
  const s=await db.collection(col).orderBy("name").get();
  s.forEach(d=>sel.innerHTML+=`<option>${d.data().name}</option>`);
}
async function loadMasters(){
  await loadMaster("makers",modalMaker);
  await loadMaster("categories",modalCategory);
  await loadMaster("makers",fMaker,true);
  await loadMaster("categories",fCategory,true);
}

/* モーダル */
async function openModal(barcode){
  if(!barcode) return;
  currentBarcode=barcode;
  modal.style.display="flex";
  modalBarcode.textContent="バーコード："+barcode;
  modalName.value="";
  modalQty.value=1;
  modalStock.textContent="0";
  history.innerHTML="";

  await loadMasters();
  const ref=db.collection("products").doc(barcode);
  const s=await ref.get();
  if(s.exists){
    const p=s.data();
    modalName.value=p.name||"";
    modalMaker.value=p.manufacturer||"";
    modalCategory.value=p.category||"";
    modalStock.textContent=p.stock||0;
  }

  const h=await ref.collection("history").orderBy("time","desc").limit(10).get();
  h.forEach(d=>{
    const x=d.data();
    history.innerHTML+=`${x.type} ${x.qty}（${new Date(x.time).toLocaleString()}）<br>`;
  });
}
function closeModal(){ modal.style.display="none"; }

/* 保存 */
async function saveOnly(){
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value
  },{merge:true});
  loadProducts(); closeModal();
}

/* 在庫処理 + 履歴 */
async function submitStock(type){
  const ref=db.collection("products").doc(currentBarcode);
  const s=await ref.get();
  let stock=s.exists?(s.data().stock||0):0;
  const q=+modalQty.value;
  if(type!=="in" && stock<q) return alert("在庫不足");

  stock += (type==="in"?q:-q);

  await ref.set({stock},{merge:true});
  await ref.collection("history").add({
    type, qty:q, time:Date.now()
  });

  loadProducts(); closeModal();
}

/* 削除 */
async function deleteProduct(){
  if(confirm("削除しますか？")){
    await db.collection("products").doc(currentBarcode).delete();
    loadProducts(); closeModal();
  }
}

/* 一覧 + 並び替え */
async function loadProducts(){
  productList.innerHTML="";
  products=[];
  const s=await db.collection("products").get();
  s.forEach(d=>{
    const p=d.data();
    if(filter.barcode && !p.barcode.includes(filter.barcode)) return;
    if(filter.name && !p.name?.includes(filter.name)) return;
    if(filter.maker && p.manufacturer!==filter.maker) return;
    if(filter.category && p.category!==filter.category) return;
    products.push(p);
  });

  const k=sortKey.value,o=sortOrder.value;
  if(k) products.sort((a,b)=>{
    const A=a[k]??"",B=b[k]??"";
    return typeof A==="number"
      ? (o==="asc"?A-B:B-A)
      : (o==="asc"?String(A).localeCompare(B,"ja"):String(B).localeCompare(A,"ja"));
  });

  products.forEach(p=>{
    productList.innerHTML+=`
      <li class="product">
        <strong>${p.name||"(未入力)"}</strong><br>
        ${p.barcode}<br>
        ${p.manufacturer||""} / ${p.category||""}<br>
        在庫：<span class="${(p.stock||0)===0?'out':''}">${p.stock||0}</span><br>
        <button onclick="openModal('${p.barcode}')">編集</button>
      </li>`;
  });
}

/* 検索 */
function applyFilter(){
  filter={barcode:fBarcode.value,name:fName.value,maker:fMaker.value,category:fCategory.value};
  loadProducts();
}
function clearFilter(){
  filter={}; fBarcode.value=fName.value="";
  fMaker.value=fCategory.value="";
  loadProducts();
}

/* CSV */
function exportCSV(){
  let csv="バーコード,商品名,メーカー,カテゴリ,在庫\n";
  products.forEach(p=>{
    csv+=`${p.barcode},"${p.name||""}","${p.manufacturer||""}","${p.category||""}",${p.stock||0}\n`;
  });
  location.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
}

/* 認証 */
auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadMasters(); loadProducts();
  }
});
</script>
</body>
</html>
