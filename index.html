
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhoneå¯¾å¿œãƒ»å®Œå…¨å®‰å®šç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, select, button { width:100%; margin-bottom:6px; font-size:16px; }
button { padding:8px; }
.flex { display:flex; gap:6px; flex-wrap:wrap; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.small { font-size:0.85em; color:#555; }
.danger { background:#c00; color:#fff; }
.csvBtn { display:block; margin-top:10px; background:#0a7; color:#fff; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button type="button" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button type="button" onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- ã‚¢ãƒ—ãƒª -->
<div id="appDiv" class="hidden">
<button type="button" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button type="button" id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€</button>
<p id="result">æœªèª­ã¿å–ã‚Š</p>
<div id="scanner"></div>

<hr>
<h3>æ‰‹å‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</h3>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·">
<button type="button" onclick="manualBarcodeSet()">é–‹ã</button>

<hr>
<h3>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œç´¢">
<input id="fName" placeholder="å•†å“åæ¤œç´¢">
<select id="fMaker"></select>
<select id="fCategory"></select>

<button type="button" onclick="applyFilter()">æ¤œç´¢</button>
<button type="button" onclick="clearFilter()">è§£é™¤</button>

<!-- âœ… iPhoneå¯¾å¿œ CSVå‡ºåŠ›ãƒœã‚¿ãƒ³ -->
<button type="button" class="csvBtn" onclick="exportCSV()">ğŸ“¤ CSVå‡ºåŠ›</button>

<hr>
<div class="flex">
<select id="sortKey">
  <option value="">ä¸¦ã³æ›¿ãˆãªã—</option>
  <option value="name">å•†å“å</option>
  <option value="category">ã‚«ãƒ†ã‚´ãƒª</option>
  <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
  <option value="stock">åœ¨åº«æ•°</option>
  <option value="latestPrice">ä»•å…¥ä¾¡æ ¼</option>
  <option value="retailPrice">è²©å£²ä¾¡æ ¼</option>
</select>
<select id="sortOrder">
  <option value="asc">æ˜‡é †</option>
  <option value="desc">é™é †</option>
</select>
<button type="button" onclick="loadProducts()">ä¸¦ã³æ›¿ãˆ</button>
</div>

<hr>
<h2>å•†å“ä¸€è¦§</h2>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>

<input id="modalName" placeholder="å•†å“å">

<label class="small">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
<select id="modalMaker"></select>

<label class="small">ã‚«ãƒ†ã‚´ãƒª</label>
<select id="modalCategory"></select>

<input id="modalQty" type="number" min="1" value="1">
<input id="modalPrice" type="number" placeholder="ä»•å…¥å˜ä¾¡">
<input id="modalRetail" type="number" placeholder="è²©å£²ä¾¡æ ¼">

<button type="button" onclick="saveOnly()">ğŸ’¾ ä¿å­˜</button>
<button type="button" onclick="submitModal('in')">â• ä»•å…¥</button>
<button type="button" onclick="submitModal('out')">â– è²©å£²</button>
<button type="button" class="danger" onclick="deleteProduct()">ğŸ—‘ å‰Šé™¤</button>
<button type="button" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentBarcode=null;
let filter={};
let lastProducts=[];

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function signup(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message);}
function logout(){auth.signOut();}

/* ãƒã‚¹ã‚¿ãƒ¼ */
async function loadMasters(){
  const load=async(c,s,a)=>{
    s.innerHTML=a?"<option value=''>ã™ã¹ã¦</option>":"";
    const snap=await db.collection(c).orderBy("name").get();
    snap.forEach(d=>s.innerHTML+=`<option>${d.data().name}</option>`);
  };
  await load("makers",modalMaker);
  await load("categories",modalCategory);
  await load("makers",fMaker,true);
  await load("categories",fCategory,true);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(b){
  currentBarcode=b;
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+b;
  modal.style.display="flex";

  modalName.value="";
  modalQty.value=1;
  modalPrice.value="";
  modalRetail.value="";

  await loadMasters();

  const snap=await db.collection("products").doc(b).get();
  if(!snap.exists) return;
  const p=snap.data();
  modalName.value=p.name||"";
  modalMaker.value=p.manufacturer||"";
  modalCategory.value=p.category||"";
  modalPrice.value=p.latestPrice||"";
  modalRetail.value=p.retailPrice||"";
}

function closeModal(){ currentBarcode=null; modal.style.display="none"; }

/* ä¿å­˜ï¼ˆç¢ºå®Ÿåæ˜ ï¼‰ */
async function saveOnly(){
  if(!currentBarcode) return;
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    latestPrice:Number(modalPrice.value)||0,
    retailPrice:Number(modalRetail.value)||0,
    stock: firebase.firestore.FieldValue.increment(0)
  },{merge:true});
  await loadProducts();
  closeModal();
}

async function submitModal(type){
  const ref=db.collection("products").doc(currentBarcode);
  const snap=await ref.get();
  let stock = snap.exists ? Number(snap.data().stock||0) : 0;
  const qty = Number(modalQty.value)||0;

  if(type==="in") stock+=qty;
  else{
    if(stock<qty) return alert("åœ¨åº«ä¸è¶³");
    stock-=qty;
  }

  await ref.set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    stock:stock,
    latestPrice:Number(modalPrice.value)||0,
    retailPrice:Number(modalRetail.value)||0
  },{merge:true});

  await loadProducts();
  closeModal();
}

async function deleteProduct(){
  if(!confirm("å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await db.collection("products").doc(currentBarcode).delete();
  await loadProducts();
  closeModal();
}

/* ä¸€è¦§ */
async function loadProducts(){
  productList.innerHTML="";
  lastProducts=[];
  const snap=await db.collection("products").get();
  snap.forEach(d=>{
    const p=d.data();
    if(filter.barcode && !p.barcode.includes(filter.barcode)) return;
    if(filter.name && !p.name?.includes(filter.name)) return;
    if(filter.maker && p.manufacturer!==filter.maker) return;
    if(filter.category && p.category!==filter.category) return;
    lastProducts.push(p);
  });

  const key=sortKey.value, order=sortOrder.value;
  if(key){
    lastProducts.sort((a,b)=>{
      const x=Number(a[key]??0), y=Number(b[key]??0);
      return order==="asc"?x-y:y-x;
    });
  }

  lastProducts.forEach(p=>{
    const stock=Number(p.stock)||0;
    productList.innerHTML+=`
    <li class="product">
      <strong>${p.name||"(æœªå…¥åŠ›)"}</strong><br>
      ${p.barcode}<br>
      ${p.manufacturer||""} / ${p.category||""}<br>
      åœ¨åº«: <span class="${stock===0?'out':''}">${stock}</span><br>
      ä»•å…¥:${p.latestPrice||0} / è²©å£²:${p.retailPrice||0}<br>
      <button type="button" onclick="openModal('${p.barcode}')">ç·¨é›†</button>
    </li>`;
  });
}

/* CSV */
function exportCSV(){
  if(!lastProducts.length) return alert("å•†å“ãŒã‚ã‚Šã¾ã›ã‚“");
  let csv="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,å•†å“å,ãƒ¡ãƒ¼ã‚«ãƒ¼,ã‚«ãƒ†ã‚´ãƒª,åœ¨åº«,ä»•å…¥ä¾¡æ ¼,è²©å£²ä¾¡æ ¼\n";
  lastProducts.forEach(p=>{
    csv+=`"${p.barcode}","${p.name||""}","${p.manufacturer||""}","${p.category||""}",${p.stock||0},${p.latestPrice||0},${p.retailPrice||0}\n`;
  });
  const bom=new Uint8Array([0xEF,0xBB,0xBF]);
  const blob=new Blob([bom,csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="inventory.csv";
  a.click();
}

/* ãƒ•ã‚£ãƒ«ã‚¿ */
function applyFilter(){
  filter={
    barcode:fBarcode.value.trim(),
    name:fName.value.trim(),
    maker:fMaker.value,
    category:fCategory.value
  };
  loadProducts();
}
function clearFilter(){
  filter={};
  fBarcode.value=fName.value="";
  fMaker.value=fCategory.value="";
  loadProducts();
}

/* ã‚¹ã‚­ãƒ£ãƒ³ */
scanBtn.onclick=()=>{
  Quagga.init({inputStream:{type:"LiveStream",target:"#scanner"},decoder:{readers:["ean_reader"]}},()=>Quagga.start());
  Quagga.onDetected(d=>{
    Quagga.stop();
    openModal(d.codeResult.code);
  });
};

function manualBarcodeSet(){
  if(manualBarcode.value) openModal(manualBarcode.value.trim());
  manualBarcode.value="";
}

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadMasters(); loadProducts();
  }
});
</script>
</body>
</html>
