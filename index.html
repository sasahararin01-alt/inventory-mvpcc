
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª å®Œå…¨ç‰ˆï¼ˆèªè¨¼ä»˜ããƒ»é‡è¤‡é˜²æ­¢ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; padding: 10px; }
    .hidden { display: none; }
    .out { color: red; font-weight: bold; }
    .product { border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; }
    input { width: 90%; margin-bottom: 4px; }
    button.saveBtn, button.historyBtn, button.deleteBtn { margin-top: 4px; margin-bottom: 4px; }
    .history { font-size: 0.9em; margin-left: 10px; }
    .modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modalContent { background:#fff; padding:20px; border-radius:5px; width:90%; max-width:400px; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆèªè¨¼ä»˜ããƒ»é‡è¤‡é˜²æ­¢ï¼‰</h1>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginDiv">
    <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
    ãƒ¡ãƒ¼ãƒ«:<br>
    <input id="email" type="email"><br>
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:<br>
    <input id="password" type="password"><br>
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <div id="appDiv" class="hidden">
    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <hr>
    <button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
    <p id="result">æœªèª­ã¿å–ã‚Š</p>
    <div id="scanner" style="max-width:400px;"></div>

    <div style="margin-top:10px;">
      æ•°é‡:
      <input id="qty" type="number" value="1" min="1" style="width:60px;">
      <br><br>
      <button onclick="manualAdjust('in')">ğŸ“¦ æ‰‹å‹•ä»•å…¥</button>
      <button onclick="manualAdjust('out')">ğŸ›’ æ‰‹å‹•è²©å£²</button>
    </div>

    <hr>
    <h3>çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
    ãƒ¡ãƒ¼ã‚«ãƒ¼: <input id="filterMaker" placeholder="ä¾‹: meiji">
    ã‚«ãƒ†ã‚´ãƒª: <input id="filterCategory" placeholder="ä¾‹: é£²æ–™">
    <button onclick="applyFilter()">é©ç”¨</button>
    <button onclick="clearFilter()">è§£é™¤</button>

    <hr>
    <h2>å•†å“ä¸€è¦§</h2>
    <ul id="productList"></ul>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal" class="modal">
    <div class="modalContent">
      <h3>ä»•å…¥/è²©å£²ç™»éŒ²</h3>
      <p id="modalBarcode"></p>
      <label>æ•°é‡:</label>
      <input id="modalQty" type="number" value="1" min="1"><br>
      <div id="purchaseFields">
        <label>ä»•å…¥ä¾¡æ ¼:</label>
        <input id="modalPrice" type="number" value="0"><br>
        <label>ä¸Šä»£:</label>
        <input id="modalRetail" type="number" value="0"><br>
      </div>
      <button onclick="submitModal('in')">ä»•å…¥ç™»éŒ²</button>
      <button onclick="submitModal('out')">è²©å£²ç™»éŒ²</button>
      <button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <script>
    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
      authDomain: "inventory-mvpcc.firebaseapp.com",
      projectId: "inventory-mvpcc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentBarcode = null;
    let currentFilter = { maker: "", category: "" };

    // èªè¨¼é–¢æ•°
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .then(()=>{ document.getElementById("loginDiv").classList.add("hidden"); document.getElementById("appDiv").classList.remove("hidden"); loadProducts(); })
        .catch(e=>document.getElementById("loginMsg").textContent=e.message);
    }
    function signup() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(()=>login())
        .catch(e=>document.getElementById("loginMsg").textContent=e.message);
    }
    function logout() { auth.signOut(); location.reload(); }

    // Firestore é€£å‹•é–¢æ•°
    async function ensureProduct(barcode) {
      const ref = db.collection("products").doc(barcode);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({
          barcode,
          name: "æœªè¨­å®š",
          manufacturer: "",
          category: "",
          stock: 0,
          averageCost: 0,
          retailPrice: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    function openModal(barcode) {
      currentBarcode = barcode;
      document.getElementById("modalBarcode").textContent = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: " + barcode;
      document.getElementById("modalQty").value = 1;
      document.getElementById("modalPrice").value = 0;
      document.getElementById("modalRetail").value = 0;
      document.getElementById("modal").style.display = "flex";
    }

    function closeModal() { document.get
