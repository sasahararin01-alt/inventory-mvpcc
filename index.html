
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhone / Android å®Œå…¨å¯¾å¿œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:sans-serif;padding:10px;margin:0}
.hidden{display:none}
.product{border-bottom:1px solid #ccc;padding:8px}
.out{color:red;font-weight:bold}
input,select,button{width:100%;font-size:16px;padding:8px;margin-bottom:6px}
button{cursor:pointer}
.flex{display:flex;gap:6px}

/* iOSå®Œå…¨å¯¾å¿œãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:1000;
}
.modalContent{
  background:#fff;
  width:95%;
  max-width:420px;
  margin:10px auto;
  padding:15px;
  border-radius:6px;
  max-height:90vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

#scanner{width:100%;height:240px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h2>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h2>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ‰‹å…¥åŠ›">
<button onclick="openModal(manualBarcode.value)">é–‹ã</button>

<hr>
<h4>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h4>
<input id="fName" placeholder="å•†å“å">
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">æ¤œç´¢</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<h4>â†• ä¸¦ã³æ›¿ãˆ</h4>
<select id="sortKey">
  <option value="">ãªã—</option>
  <option value="name">å•†å“å</option>
  <option value="stock">åœ¨åº«æ•°</option>
  <option value="avgBuyPrice">ä»•å…¥é‡‘é¡</option>
  <option value="barcode">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</option>
</select>
<select id="sortOrder">
  <option value="asc">æ˜‡é †</option>
  <option value="desc">é™é †</option>
</select>
<button onclick="loadProducts()">ä¸¦ã³æ›¿ãˆ</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>

<p id="mBarcode"></p>
<p>ç¾åœ¨åº«ï¼š<b id="mStock">0</b></p>

<input id="mName" placeholder="å•†å“å">

<select id="mMaker"></select>
<div class="flex">
<button onclick="editMaster('makers',mMaker)">âœï¸</button>
<button onclick="deleteMaster('makers',mMaker)">ğŸ—‘</button>
</div>
<input id="newMaker" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼è¿½åŠ ">
<button onclick="addMaster('makers')">ï¼‹</button>

<select id="mCategory"></select>
<div class="flex">
<button onclick="editMaster('categories',mCategory)">âœï¸</button>
<button onclick="deleteMaster('categories',mCategory)">ğŸ—‘</button>
</div>
<input id="newCategory" placeholder="ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ">
<button onclick="addMaster('categories')">ï¼‹</button>

<input id="mSell" type="number" placeholder="ä¸Šä»£ï¼ˆè²©å£²ä¾¡æ ¼ï¼‰">
<input id="mBuy" type="number" placeholder="ä»Šå›ä»•å…¥å˜ä¾¡">
<p>å¹³å‡ä»•å…¥å˜ä¾¡ï¼š<b id="mAvg">0</b></p>
<input id="mVendor" placeholder="ä»Šå›ä»•å…¥å•å±‹">
<input id="mQty" type="number" value="1" min="1">

<button onclick="saveOnly()">ğŸ’¾ ä¿å­˜</button>
<button onclick="stockAction('in')">ğŸ“¥ ä»•å…¥</button>
<button onclick="stockAction('out')">ğŸ“¤ è²©å£²</button>
<button onclick="stockAction('use')">ğŸ§´ ä½¿ç”¨</button>
<button onclick="closeModal()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
})

const auth=firebase.auth(),db=firebase.firestore()
const el=id=>document.getElementById(id)
let currentBarcode=null,filter={},makerMap={},categoryMap={}

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(el('email').value,el('password').value)}
function signup(){auth.createUserWithEmailAndPassword(el('email').value,el('password').value)}
function logout(){auth.signOut()}

/* ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ */
function startScan(){
  el('scanner').innerHTML=""
  Quagga.init({
    inputStream:{type:"LiveStream",target:el('scanner'),constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader","code_128_reader"]}
  },()=>{
    Quagga.start()
    Quagga.onDetected(d=>{
      Quagga.stop()
      openModal(d.codeResult.code)
    })
  })
}

/* ãƒã‚¹ã‚¿ãƒ¼ */
async function loadMaster(col,sel,all){
  sel.innerHTML=all?'<option value="">ã™ã¹ã¦</option>':''
  const s=await db.collection(col).orderBy("name").get()
  s.forEach(d=>{
    sel.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`
    if(col==="makers") makerMap[d.id]=d.data().name
    if(col==="categories") categoryMap[d.id]=d.data().name
  })
}
async function loadMasters(){
  makerMap={};categoryMap={}
  await loadMaster("makers",el('fMaker'),true)
  await loadMaster("categories",el('fCategory'),true)
  await loadMaster("makers",el('mMaker'))
  await loadMaster("categories",el('mCategory'))
}
async function addMaster(col){
  const v=el(col==="makers"?'newMaker':'newCategory').value
  if(!v)return
  await db.collection(col).add({name:v})
  loadMasters()
}
async function editMaster(col,sel){
  if(!sel.value)return
  const d=await db.collection(col).doc(sel.value).get()
  const n=prompt("æ–°åç§°",d.data().name)
  if(n) await db.collection(col).doc(sel.value).update({name:n})
  loadMasters()
}
async function deleteMaster(col,sel){
  if(!sel.value)return
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    await db.collection(col).doc(sel.value).delete()
    loadMasters()
  }
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(barcode){
  if(!barcode)return
  currentBarcode=barcode
  el('modal').style.display="block"
  el('mBarcode').textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼š"+barcode
  el('mQty').value=1
  await loadMasters()

  const ref=db.collection("products").doc(barcode)
  const s=await ref.get()
  if(s.exists){
    const p=s.data()
    el('mName').value=p.name||""
    el('mMaker').value=p.manufacturerId||""
    el('mCategory').value=p.categoryId||""
    el('mSell').value=p.sellPrice||0
    el('mAvg').textContent=p.avgBuyPrice||0
    el('mStock').textContent=p.stock||0
  }else{
    el('mName').value=""
    el('mSell').value=0
    el('mAvg').textContent=0
    el('mStock').textContent=0
  }
}
function closeModal(){el('modal').style.display="none"}

/* ä¿å­˜ */
async function saveOnly(){
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:el('mName').value,
    manufacturerId:el('mMaker').value,
    categoryId:el('mCategory').value,
    sellPrice:+el('mSell').value||0
  },{merge:true})
  closeModal();loadProducts()
}

/* åœ¨åº«æ“ä½œ */
async function stockAction(type){
  const ref=db.collection("products").doc(currentBarcode)
  const s=await ref.get()
  let stock=s.exists?(s.data().stock||0):0
  const q=+el('mQty').value
  if(type!=="in" && stock<q) return alert("åœ¨åº«ä¸è¶³")

  stock+=type==="in"?q:-q

  let total=s.exists?(s.data().totalBuy||0):0
  let cnt=s.exists?(s.data().totalQty||0):0
  if(type==="in"){
    total+=q*(+el('mBuy').value||0)
    cnt+=q
  }

  await ref.set({
    stock,
    totalBuy:total,
    totalQty:cnt,
    avgBuyPrice:cnt?Math.round(total/cnt):0
  },{merge:true})

  closeModal();loadProducts()
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ä¸¦ã³æ›¿ãˆ */
function applyFilter(){
  filter={
    name:el('fName').value,
    barcode:el('fBarcode').value,
    maker:el('fMaker').value,
    category:el('fCategory').value
  }
  loadProducts()
}
function clearFilter(){
  filter={}
  el('fName').value=""
  el('fBarcode').value=""
  el('fMaker').value=""
  el('fCategory').value=""
  loadProducts()
}

async function loadProducts(){
  el('productList').innerHTML=""
  let list=[]
  const s=await db.collection("products").get()
  s.forEach(d=>{
    const p=d.data()
    if(filter.name && !(p.name||"").includes(filter.name))return
    if(filter.barcode && !(p.barcode||"").includes(filter.barcode))return
    if(filter.maker && p.manufacturerId!==filter.maker)return
    if(filter.category && p.categoryId!==filter.category)return
    list.push(p)
  })

  const k=el('sortKey').value,o=el('sortOrder').value
  if(k){
    list.sort((a,b)=>{
      const A=a[k]??"",B=b[k]??""
      return typeof A==="number"
        ? (o==="asc"?A-B:B-A)
        : (o==="asc"?String(A).localeCompare(B,"ja"):String(B).localeCompare(A,"ja"))
    })
  }

  list.forEach(p=>{
    el('productList').innerHTML+=`
      <li class="product">
        <b>${p.name||"(æœªå…¥åŠ›)"}</b><br>
        ${p.barcode}<br>
        åœ¨åº«ï¼š<span class="${p.stock==0?'out':''}">${p.stock||0}</span><br>
        <button onclick="openModal('${p.barcode}')">âœï¸ ç·¨é›†</button>
      </li>`
  })
}

/* CSV */
function exportCSV(){
  let csv="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,å•†å“å,åœ¨åº«,å¹³å‡ä»•å…¥\n"
  db.collection("products").get().then(s=>{
    s.forEach(d=>{
      const p=d.data()
      csv+=`${p.barcode},"${p.name||""}",${p.stock||0},${p.avgBuyPrice||0}\n`
    })
    const blob=new Blob([csv],{type:"text/csv"})
    const a=document.createElement("a")
    a.href=URL.createObjectURL(blob)
    a.download="inventory.csv"
    a.click()
  })
}

auth.onAuthStateChanged(u=>{
  if(u){
    el('loginDiv').classList.add("hidden")
    el('appDiv').classList.remove("hidden")
    loadMasters()
    loadProducts()
  }
})
</script>
</body>
</html>
