
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:sans-serif;margin:0;padding:10px}
.hidden{display:none}
.product{border-bottom:1px solid #ccc;padding:8px}
.out{color:red;font-weight:bold}
input,select,button{width:100%;font-size:16px;padding:8px;margin-bottom:6px}
button{cursor:pointer}
.flex{display:flex;gap:6px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:1000}
.modalContent{
  background:#fff;width:95%;max-width:420px;
  margin:10px auto;padding:15px;border-radius:6px;
  max-height:90vh;overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.history li{font-size:14px;border-bottom:1px dotted #ccc;padding:4px}
#scanner{height:240px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h2>åœ¨åº«ç®¡ç†</h2>

<div id="loginDiv">
<input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
<input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="signup()">æ–°è¦ç™»éŒ²</button>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
<div id="scanner"></div>

<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ‰‹å…¥åŠ›">
<button onclick="openModal(manualBarcode.value)">ç™»éŒ² / ç·¨é›†</button>

<hr>
<h4>ğŸ” çµã‚Šè¾¼ã¿</h4>
<input id="fName" placeholder="å•†å“å">
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">æ¤œç´¢</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<h4>â†• ä¸¦ã³æ›¿ãˆ</h4>
<select id="sortKey">
<option value="">ãªã—</option>
<option value="name">å•†å“å</option>
<option value="stock">åœ¨åº«æ•°</option>
<option value="avgBuyPrice">å¹³å‡ä»•å…¥</option>
<option value="barcode">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</option>
</select>
<select id="sortOrder">
<option value="asc">æ˜‡é †</option>
<option value="desc">é™é †</option>
</select>
<button onclick="loadProducts()">é©ç”¨</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="mBarcode"></p>
<p>ç¾åœ¨åº«ï¼š<b id="mStock">0</b></p>

<input id="mName" placeholder="å•†å“å">

<select id="mMaker"></select>
<div class="flex">
<button onclick="addMaster('makers')">ï¼‹</button>
<button onclick="editMaster('makers',mMaker)">âœï¸</button>
<button onclick="deleteMaster('makers',mMaker)">ğŸ—‘</button>
</div>

<select id="mCategory"></select>
<div class="flex">
<button onclick="addMaster('categories')">ï¼‹</button>
<button onclick="editMaster('categories',mCategory)">âœï¸</button>
<button onclick="deleteMaster('categories',mCategory)">ğŸ—‘</button>
</div>

<input id="mSell" type="number" placeholder="ä¸Šä»£">
<input id="mBuy" type="number" placeholder="ä»Šå›ä»•å…¥å˜ä¾¡">
<p>å¹³å‡ä»•å…¥ï¼š<b id="mAvg">0</b></p>
<input id="mVendor" placeholder="ä»•å…¥å•å±‹">
<input id="mQty" type="number" value="1" min="1">

<button onclick="saveOnly()">ä¿å­˜</button>
<button onclick="stockAction('in')">ä»•å…¥</button>
<button onclick="stockAction('out')">è²©å£²</button>
<button onclick="stockAction('use')">ä½¿ç”¨</button>
<button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>

<hr>
<h4>ğŸ“¦ åœ¨åº«å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</h4>
<ul id="historyList" class="history"></ul>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
})
const auth=firebase.auth(),db=firebase.firestore()
const el=id=>document.getElementById(id)

let currentBarcode="",filter={},list=[]
let makers={},categories={}

/* èªè¨¼ */
function login(){auth.signInWithEmailAndPassword(el('email').value,el('password').value)}
function signup(){auth.createUserWithEmailAndPassword(el('email').value,el('password').value)}
function logout(){auth.signOut()}

/* ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ */
function startScan(){
  try{Quagga.stop()}catch(e){}
  el("scanner").innerHTML=""
  Quagga.init({
    inputStream:{type:"LiveStream",target:el("scanner"),constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader","code_128_reader"]}
  },()=>{
    Quagga.start()
    Quagga.onDetected(d=>{
      Quagga.stop()
      openModal(d.codeResult.code)
    })
  })
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
async function openModal(barcode){
  if(!barcode){alert("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}
  currentBarcode=barcode
  el("modal").style.display="block"
  el("mBarcode").textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼š"+barcode
  el("mQty").value=1
  await loadMasters()
  loadHistory(barcode)

  const s=await db.collection("products").doc(barcode).get()
  if(s.exists){
    const p=s.data()
    el("mName").value=p.name||""
    el("mSell").value=p.sellPrice||0
    el("mAvg").textContent=p.avgBuyPrice||0
    el("mStock").textContent=p.stock||0
    el("mVendor").value=p.lastVendor||""
    el("mMaker").value=p.makerId||""
    el("mCategory").value=p.categoryId||""
  }else{
    el("mName").value=""
    el("mSell").value=0
    el("mAvg").textContent=0
    el("mStock").textContent=0
    el("mVendor").value=""
  }
}
function closeModal(){el("modal").style.display="none"}

/* CSV */
function exportCSV(){
  let csv="å•†å“å,ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,ãƒ¡ãƒ¼ã‚«ãƒ¼,ã‚«ãƒ†ã‚´ãƒª,åœ¨åº«,å¹³å‡ä»•å…¥\n"
  list.forEach(p=>{
    csv+=`${p.name},${p.barcode},${makers[p.makerId]||""},${categories[p.categoryId]||""},${p.stock},${p.avgBuyPrice||0}\n`
  })
  const blob=new Blob([csv],{type:"text/csv"})
  const url=URL.createObjectURL(blob)
  const a=document.createElement("a")
  a.href=url
  a.download="inventory.csv"
  a.click()
  setTimeout(()=>URL.revokeObjectURL(url),1000)
}
