
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆå®Œå…¨ç‰ˆãƒ»æœ€çµ‚å®‰å®šï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:sans-serif; padding:10px; }
.hidden { display:none; }
.product { border-bottom:1px solid #ccc; padding:10px 0; }
.out { color:red; font-weight:bold; }
input, select { width:95%; margin-bottom:6px; }
button { margin:4px 0; }
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
}
.modalContent {
  background:#fff; padding:15px;
  border-radius:6px; width:95%; max-width:420px;
}
.row { display:flex; gap:4px; align-items:center; }
.row select { flex:1; }
.small { font-size:0.85em; color:#555; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="loginDiv">
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- ã‚¢ãƒ—ãƒª -->
<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€</button>
<p id="result">æœªèª­ã¿å–ã‚Š</p>
<div id="scanner" style="max-width:400px;"></div>

<hr>
<h3>æ‰‹å‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</h3>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·">
<button onclick="manualBarcodeSet()">é–‹ã</button>

<hr>
<h2>å•†å“ä¸€è¦§</h2>
<ul id="productList"></ul>
</div>

<!-- å•†å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>

<input id="modalName" placeholder="å•†å“å">

<label class="small">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
<div class="row">
  <select id="modalMaker"></select>
  <button onclick="addMasterFromModal('makers')">ï¼‹</button>
  <button onclick="editMasterFromModal('makers')">âœ</button>
</div>

<label class="small">ã‚«ãƒ†ã‚´ãƒª</label>
<div class="row">
  <select id="modalCategory"></select>
  <button onclick="addMasterFromModal('categories')">ï¼‹</button>
  <button onclick="editMasterFromModal('categories')">âœ</button>
</div>

<input id="modalQty" type="number" value="1" min="1">
<input id="modalPrice" type="number" placeholder="ä»•å…¥å˜ä¾¡">
<input id="modalRetail" type="number" placeholder="ä¸Šä»£">

<button onclick="saveOnly()">ğŸ’¾ ä¿å­˜ã®ã¿</button>
<button onclick="submitModal('in')">â• ä»•å…¥</button>
<button onclick="submitModal('out')">â– è²©å£²</button>
<button onclick="cancelModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain: "inventory-mvpcc.firebaseapp.com",
  projectId: "inventory-mvpcc"
});
const auth=firebase.auth();
const db=firebase.firestore();

let currentBarcode=null;

/* ===== èªè¨¼ ===== */
function login(){ auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message); }
function signup(){ auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>loginMsg.textContent=e.message); }
function logout(){ auth.signOut(); }

/* ===== ãƒã‚¹ã‚¿ãƒ¼ ===== */
async function loadSelect(col, select){
  select.innerHTML="";
  const snap=await db.collection(col).orderBy("name").get();
  snap.forEach(d=>{
    const o=document.createElement("option");
    o.value=o.textContent=d.data().name;
    select.appendChild(o);
  });
}

async function loadModalMasters(){
  await loadSelect("makers", modalMaker);
  await loadSelect("categories", modalCategory);
}

async function addMasterFromModal(col){
  const name=prompt("è¿½åŠ ã™ã‚‹åå‰");
  if(!name) return;
  await db.collection(col).add({name});
  await loadModalMasters();
  if(col==="makers") modalMaker.value=name;
  if(col==="categories") modalCategory.value=name;
}

async function editMasterFromModal(col){
  const select = col==="makers" ? modalMaker : modalCategory;
  const before = select.value;
  if(!before) return alert("é¸æŠã—ã¦ãã ã•ã„");
  const after = prompt("æ–°ã—ã„åå‰", before);
  if(!after) return;

  const snap = await db.collection(col).where("name","==",before).get();
  snap.forEach(d=>d.ref.update({name:after}));
  await loadModalMasters();
  select.value=after;
}

/* ===== å•†å“ ===== */
function openModal(barcode){
  currentBarcode=barcode;
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+barcode;
  modalName.value="";
  modalQty.value=1;
  modalPrice.value="";
  modalRetail.value="";
  modal.style.display="flex";

  loadModalMasters().then(()=>{
    db.collection("products").doc(barcode).get().then(s=>{
      if(!s.exists) return;
      const p=s.data();
      modalName.value=p.name||"";
      modalMaker.value=p.manufacturer||"";
      modalCategory.value=p.category||"";
      modalPrice.value=p.latestPrice||"";
      modalRetail.value=p.retailPrice||"";
    });
  });
}

function cancelModal(){
  currentBarcode=null;
  modal.style.display="none";
}

async function saveOnly(){
  if(!currentBarcode) return;
  await db.collection("products").doc(currentBarcode).set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    latestPrice:+modalPrice.value||0,
    retailPrice:+modalRetail.value||0
  },{merge:true});
  cancelModal(); loadProducts();
}

async function submitModal(type){
  const ref=db.collection("products").doc(currentBarcode);
  const snap=await ref.get();
  let p=snap.exists?snap.data():{stock:0,averageCost:0};
  const qty=+modalQty.value;

  if(type==="in"){
    p.averageCost=((p.averageCost*p.stock)+(+modalPrice.value*qty))/(p.stock+qty);
    p.stock+=qty;
  }else{
    if(p.stock<qty) return alert("åœ¨åº«ä¸è¶³");
    p.stock-=qty;
  }

  await ref.set({
    barcode:currentBarcode,
    name:modalName.value,
    manufacturer:modalMaker.value,
    category:modalCategory.value,
    stock:p.stock,
    averageCost:p.averageCost,
    latestPrice:+modalPrice.value||0,
    retailPrice:+modalRetail.value||0
  },{merge:true});

  cancelModal(); loadProducts();
}

/* ===== ä¸€è¦§ ===== */
async function loadProducts(){
  productList.innerHTML="";
  const snap=await db.collection("products").get();
  snap.forEach(d=>{
    const p=d.data();
    const li=document.createElement("li");
    li.className="product";
    li.innerHTML=`
      <strong>${p.name||"(æœªå…¥åŠ›)"}</strong><br>
      ${p.barcode}<br>
      åœ¨åº«: <span class="${p.stock===0?'out':''}">${p.stock||0}</span><br>
      <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
    `;
    productList.appendChild(li);
  });
}

/* ===== ã‚¹ã‚­ãƒ£ãƒ³ ===== */
scanBtn.onclick=()=>{
  Quagga.init({
    inputStream:{type:"LiveStream",target:"#scanner",constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },()=>Quagga.start());

  Quagga.onDetected(d=>{
    Quagga.stop();
    openModal(d.codeResult.code);
  });
};

function manualBarcodeSet(){
  const c=manualBarcode.value.trim();
  if(!c) return;
  manualBarcode.value="";
  openModal(c);
}

/* åˆæœŸ */
auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadProducts();
  }
});
</script>
</body>
</html>
