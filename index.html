
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆã‚«ãƒ†ã‚´ãƒªå³æ™‚åæ˜ ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; padding: 10px; }
.hidden { display: none; }
.out { color: red; font-weight: bold; }
.product { border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; }
input, select { width: 90%; margin-bottom: 4px; }
button.saveBtn, button.historyBtn, button.deleteBtn { margin-top: 4px; margin-bottom: 4px; }
.history { font-size: 0.9em; margin-left: 10px; }
.modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modalContent { background:#fff; padding:20px; border-radius:5px; width:90%; max-width:400px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆã‚«ãƒ†ã‚´ãƒªå³æ™‚åæ˜ ï¼‰</h1>

<div id="loginDiv">
<h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
ãƒ¡ãƒ¼ãƒ«:<br><input id="email" type="email"><br>
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:<br><input id="password" type="password"><br>
<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="signup()">æ–°è¦ç™»éŒ²</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
<hr>

<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<p id="result">æœªèª­ã¿å–ã‚Š</p>
<div id="scanner" style="max-width:400px;"></div>

<hr>
<h3>æ‰‹å‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²</h3>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›">
<button onclick="manualBarcodeSet()">ç™»éŒ²</button>

<hr>
<h3>çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
ãƒ¡ãƒ¼ã‚«ãƒ¼: <input id="filterMaker" placeholder="ä¾‹: meiji">
ã‚«ãƒ†ã‚´ãƒª: <input id="filterCategory" placeholder="ä¾‹: é£²æ–™">
<button onclick="applyFilter()">é©ç”¨</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
<hr>

<h2>å•†å“ä¸€è¦§</h2>
<ul id="productList"></ul>
</div>

<!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç™»éŒ²/ç·¨é›† -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
<p id="modalBarcode"></p>
<label>å•†å“å:</label><br>
<input id="modalName"><br>
<label>ãƒ¡ãƒ¼ã‚«ãƒ¼:</label><br>
<input id="modalMaker"><br>
<label>ã‚«ãƒ†ã‚´ãƒª:</label><br>
<select id="modalCategory"></select>
<button onclick="promptNewCategory()">æ–°è¦ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button><br>
<label>æ•°é‡:</label><br>
<input id="modalQty" type="number" value="1" min="1"><br>
<label>ä»•å…¥ä¾¡æ ¼:</label><br>
<input id="modalPrice" type="number" value="0"><br>
<label>ä¸Šä»£:</label><br>
<input id="modalRetail" type="number" value="0"><br>
<button onclick="submitModal('in')">ä»•å…¥ç™»éŒ²</button>
<button onclick="submitModal('out')">è²©å£²ç™»éŒ²</button>
<button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain: "inventory-mvpcc.firebaseapp.com",
  projectId: "inventory-mvpcc"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentBarcode = null;
let currentFilter = { maker: "", category: "" };
let categories = [];

window.login = function() {
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>{ document.getElementById("loginDiv").classList.add("hidden"); document.getElementById("appDiv").classList.remove("hidden"); loadProducts(); })
    .catch(e=>document.getElementById("loginMsg").textContent=e.message);
}

window.signup = function() {
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email,password)
    .then(()=>login())
    .catch(e=>document.getElementById("loginMsg").textContent=e.message);
}

window.logout=function(){ auth.signOut(); location.reload(); }

async function ensureProduct(barcode){
  const ref=db.collection("products").doc(barcode);
  const snap=await ref.get();
  if(!snap.exists){
    await ref.set({
      barcode,
      name:"æœªè¨­å®š",
      manufacturer:"",
      category:"",
      stock:0,
      averageCost:0,
      latestPrice:0,
      retailPrice:0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

async function loadCategories(){
  const snap=await db.collection("categories").orderBy("name").get();
  categories=snap.docs.map(d=>d.data().name);
  return categories;
}

async function populateCategoryDropdown(selected=""){
  const select=document.getElementById("modalCategory");
  select.innerHTML="";
  categories.forEach(c=>{
    const opt=document.createElement("option"); opt.value=c; opt.textContent=c; select.appendChild(opt);
  });
  const newOpt=document.createElement("option"); newOpt.value="__new__"; newOpt.textContent="æ–°è¦ã‚«ãƒ†ã‚´ãƒªè¿½åŠ "; select.appendChild(newOpt);
  if(selected) select.value=selected;
}

function promptNewCategory(){
  const name=prompt("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›");
  if(!name) return;
  db.collection("categories").add({name:name}).then(async ()=>{
    await loadCategories();
    await populateCategoryDropdown(name);
  });
}

function openModal(barcode){
  currentBarcode=barcode;
  document.getElementById("modalBarcode").textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+barcode;
  document.getElementById("modalQty").value=1;

  db.collection("products").doc(barcode).get().then(async snap=>{
    const p = snap.exists ? snap.data() : { name:"", manufacturer:"", category:"", latestPrice:0, retailPrice:0 };
    document.getElementById("modalName").value=p.name;
    document.getElementById("modalMaker").value=p.manufacturer;
    document.getElementById("modalPrice").value=p.latestPrice||0;
    document.getElementById("modalRetail").value=p.retailPrice||0;
    await loadCategories();
    await populateCategoryDropdown(p.category||"");
  });

  document.getElementById("modal").style.display="flex";
}

function closeModal(){ document.getElementById("modal").style.display="none"; }

async function submitModal(type){
  const name=document.getElementById("modalName").value;
  const maker=document.getElementById("modalMaker").value;
  let category=document.getElementById("modalCategory").value;
  if(category==="__new__") category=prompt("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›");
  const qty=Number(document.getElementById("modalQty").value);
  const price=Number(document.getElementById("modalPrice").value);
  const retail=Number(document.getElementById("modalRetail").value);

  const ref=db.collection("products").doc(currentBarcode);
  const snap=await ref.get();
  let stock=snap.data().stock;
  let averageCost=snap.data().averageCost||0;
  let latestPrice=snap.data().latestPrice||0;
  let retailPrice=snap.data().retailPrice||0;

  if(type==='in'){
    averageCost=((averageCost*stock)+(price*qty))/(stock+qty);
    stock+=qty;
    latestPrice=price;
    retailPrice=retail>0?retail:retailPrice;
    await ref.collection("history").add({ type:'in', quantity:qty, price:price, date:firebase.firestore.FieldValue.serverTimestamp() });
  } else {
    if(stock<qty) return alert("åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“");
    stock-=qty;
    await ref.collection("history").add({ type:'out', quantity:qty, date:firebase.firestore.FieldValue.serverTimestamp() });
  }

  await ref.update({ name, manufacturer:maker, category, stock, averageCost, latestPrice, retailPrice, updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
  closeModal();
  loadProducts();
}

async function manualBarcodeSet(){
  const code=document.getElementById("manualBarcode").value.trim();
  if(!code) return alert("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  document.getElementById("manualBarcode").value="";
  await ensureProduct(code);
  openModal(code);
}

async function loadProducts(){
  const list=document.getElementById("productList");
  list.innerHTML="";
  const snap=await db.collection("products").orderBy("barcode").get();
  const products=[];
  snap.forEach(doc=>{
    const p=doc.data();
    if((currentFilter.maker && p.manufacturer!==currentFilter.maker) || (currentFilter.category && p.category!==currentFilter.category)) return;
    if(products.find(prod=>prod.barcode===p.barcode)) return;
    products.push(p);
  });

  products.forEach(p=>{
    const li=document.createElement("li");
    li.className="product";
    li.innerHTML=`
      ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${p.barcode}<br>
      å•†å“å: ${p.name}<br>
      ãƒ¡ãƒ¼ã‚«ãƒ¼: ${p.manufacturer}<br>
      ã‚«ãƒ†ã‚´ãƒª: ${p.category}<br>
      åœ¨åº«: ${p.stock}<br>
      ä¸Šä»£: ${p.retailPrice}<br>
      å¹³å‡ä»•å…¥ä¾¡æ ¼: ${(p.averageCost||0).toFixed(2)}<br>
      æœ€æ–°ä»•å…¥ä¾¡æ ¼: ${p.latestPrice||0}<br>
      <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
      <button onclick="deleteProduct('${p.barcode}')">å‰Šé™¤</button>
      <button onclick="showHistory('${p.barcode}')">å±¥æ­´è¡¨ç¤º</button>
      <div id="history_${p.barcode}" class="history"></div>
    `;
    list.appendChild(li);
  });
}

async function deleteProduct(barcode){
  if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå±¥æ­´ã‚‚ã™ã¹ã¦æ¶ˆãˆã¾ã™")) return;
  const historySnap=await db.collection("products").doc(barcode).collection("history").get();
  const batch=db.batch();
  historySnap.forEach(doc=>batch.delete(doc.ref));
  batch.delete(db.collection("products").doc(barcode));
  await batch.commit();
  loadProducts();
}

async function showHistory(barcode){
  const div=document.getElementById("history_"+barcode);
  div.innerHTML="èª­ã¿è¾¼ã¿ä¸­...";
  const snap=await db.collection("products").doc(barcode).collection("history").orderBy("date","desc").get();
  if(snap.empty){ div.innerHTML="å±¥æ­´ãªã—"; return; }
  div.innerHTML="";
  snap.forEach(d=>{
    const h=d.data();
    const date=h.date?h.date.toDate().toLocaleString():"";
    if(h.type==='in') div.innerHTML+=`ä»•å…¥ ${h.quantity}å€‹ @${h.price}å†† (${date})<br>`;
    else div.innerHTML+=`è²©å£² ${h.quantity}å€‹ (${date})<br>`;
  });
}

function applyFilter(){
  currentFilter.maker=document.getElementById("filterMaker").value.trim();
  currentFilter.category=document.getElementById("filterCategory").value.trim();
  loadProducts();
}

function clearFilter(){
  document.getElementById("filterMaker").value="";
  document.getElementById("filterCategory").value="";
  currentFilter={maker:"",category:""};
  loadProducts();
}

async function exportCSV(){
  const snap=await db.collection("products").orderBy("barcode").get();
  let csv="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰,å•†å“å,ãƒ¡ãƒ¼ã‚«ãƒ¼,ã‚«ãƒ†ã‚´ãƒª,åœ¨åº«,å¹³å‡ä»•å…¥ä¾¡æ ¼,æœ€æ–°ä»•å…¥ä¾¡æ ¼,ä¸Šä»£\n";
  snap.forEach(doc=>{
    const p=doc.data();
    csv+=`"${p.barcode}","${p.name}","${p.manufacturer}","${p.category}",${p.stock},${(p.averageCost||0).toFixed(2)},${p.latestPrice||0},${p.retailPrice||0}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='inventory.csv';
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("scanBtn").addEventListener("click",()=>{
  Quagga.init({
    inputStream:{type:"LiveStream",target:document.querySelector("#scanner"),constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  }, err=>{if(err)return alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); Quagga.start();});

  Quagga.onDetected(async data=>{
    currentBarcode=data.codeResult.code;
    Quagga.stop();
    document.getElementById("result").textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+currentBarcode;
    await ensureProduct(currentBarcode);
    openModal(currentBarcode);
  });
});

auth.onAuthStateChanged(user=>{
  if(user){ document.getElementById("loginDiv").classList.add("hidden"); document.getElementById("appDiv").classList.remove("hidden"); loadProducts(); }
  else { document.getElementById("loginDiv").classList.remove("hidden"); document.getElementById("appDiv").classList.add("hidden"); }
});
</script>
</body>
</html>
