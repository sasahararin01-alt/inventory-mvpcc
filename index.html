
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆiPhoneå®Œå…¨å¯¾å¿œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:sans-serif;
  padding:10px;
  margin:0;
}

.hidden{display:none}
.product{border-bottom:1px solid #ccc;padding:8px}
.out{color:red;font-weight:bold}

input,select,button{
  width:100%;
  font-size:16px;
  padding:8px;
  margin-bottom:6px;
}

button{cursor:pointer}

/* ===== iOSå®‰å…¨ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modal{
  display:none;
  position:fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,.6);
  z-index:1000;
}

.modalContent{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  width:95%;
  max-width:420px;
  background:#fff;
  border-radius:6px;
  padding:15px;
  max-height:90vh;
  overflow-y:scroll;
  -webkit-overflow-scrolling:touch;
  touch-action:pan-y;
}

.flex{display:flex;gap:6px}
#scanner{width:100%;height:240px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>
<h2>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h2>

<div id="loginDiv">
  <input id="email" placeholder="ãƒ¡ãƒ¼ãƒ«">
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
</div>

<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
<div id="scanner"></div>

<hr>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ‰‹å…¥åŠ›">
<button onclick="openModal(manualBarcode.value)">é–‹ã</button>

<hr>
<h4>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h4>
<input id="fName" placeholder="å•†å“å">
<input id="fBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
<select id="fMaker"></select>
<select id="fCategory"></select>
<button onclick="applyFilter()">æ¤œç´¢</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
<h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>

<p id="mBarcode"></p>
<p>ç¾åœ¨åº«ï¼š<b id="mStock">0</b></p>

<input id="mName" placeholder="å•†å“å">
<select id="mMaker"></select>
<select id="mCategory"></select>

<input id="mSell" type="number" placeholder="è²©å£²ä¾¡æ ¼">
<input id="mBuy" type="number" placeholder="ä»Šå›ä»•å…¥å˜ä¾¡">
<p>å¹³å‡ä»•å…¥å˜ä¾¡ï¼š<b id="mAvg">0</b></p>

<input id="mQty" type="number" value="1" min="1">

<button onclick="saveOnly()">ğŸ’¾ ä¿å­˜</button>
<button onclick="stockAction('in')">ğŸ“¥ ä»•å…¥</button>
<button onclick="stockAction('out')">ğŸ“¤ è²©å£²</button>
<button onclick="closeModal()">âŒ é–‰ã˜ã‚‹</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain:"inventory-mvpcc.firebaseapp.com",
  projectId:"inventory-mvpcc"
})

const auth=firebase.auth()
const db=firebase.firestore()
const el=id=>document.getElementById(id)
let filter={}, currentBarcode=null

function login(){
  auth.signInWithEmailAndPassword(el('email').value,el('password').value)
}
function signup(){
  auth.createUserWithEmailAndPassword(el('email').value,el('password').value)
}
function logout(){auth.signOut()}

function startScan(){
  el('scanner').innerHTML=""
  Quagga.init({
    inputStream:{type:"LiveStream",target:el('scanner'),constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },()=>{
    Quagga.start()
    Quagga.onDetected(d=>{
      Quagga.stop()
      openModal(d.codeResult.code)
    })
  })
}

/* ===== çµã‚Šè¾¼ã¿ï¼ˆiOSå®‰å…¨ï¼‰ ===== */
function applyFilter(){
  filter={
    name:el('fName').value,
    barcode:el('fBarcode').value,
    maker:el('fMaker').value,
    category:el('fCategory').value
  }
  loadProducts()
}

function clearFilter(){
  filter={}
  el('fName').value=""
  el('fBarcode').value=""
  loadProducts()
}

async function loadProducts(){
  el('productList').innerHTML=""
  const s=await db.collection("products").get()
  s.forEach(d=>{
    const p=d.data()
    if(filter.name && !(p.name||"").includes(filter.name)) return
    if(filter.barcode && !(p.barcode||"").includes(filter.barcode)) return

    el('productList').innerHTML+=`
      <li class="product">
        <b>${p.name||"(æœªå…¥åŠ›)"}</b><br>
        ${p.barcode}<br>
        åœ¨åº«ï¼š${p.stock||0}<br>
        <button onclick="openModal('${p.barcode}')">âœï¸ ç·¨é›†</button>
      </li>`
  })
}

function openModal(barcode){
  currentBarcode=barcode
  el('modal').style.display="block"
  el('mBarcode').textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼š"+barcode
}

function closeModal(){
  el('modal').style.display="none"
}

auth.onAuthStateChanged(u=>{
  if(u){
    el('loginDiv').classList.add("hidden")
    el('appDiv').classList.remove("hidden")
    loadProducts()
  }
})
</script>
</body>
</html>
