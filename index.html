
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; padding: 10px; }
.hidden { display: none; }
.product { border-bottom: 1px solid #ccc; padding: 10px 0; }
input, select { width: 95%; margin-bottom: 6px; }
button { margin: 3px 0; }
.modal { display:none; position:fixed; inset:0; background:#0008; justify-content:center; align-items:center; }
.modalContent { background:#fff; padding:15px; border-radius:6px; width:95%; max-width:420px; }
.history { font-size: 0.9em; margin-left: 10px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="loginDiv">
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
<div id="appDiv" class="hidden">
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

<hr>
<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€</button>
<p id="result">æœªèª­ã¿å–ã‚Š</p>
<div id="scanner" style="max-width:400px;"></div>

<hr>
<h3>æ‰‹å‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</h3>
<input id="manualBarcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
<button onclick="manualBarcodeSet()">ç™»éŒ²</button>

<hr>
<h3>çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
ãƒ¡ãƒ¼ã‚«ãƒ¼:
<input id="filterMaker" placeholder="ä¾‹: meiji"><br>

ã‚«ãƒ†ã‚´ãƒª:
<select id="filterCategory"></select><br>

<button onclick="applyFilter()">é©ç”¨</button>
<button onclick="clearFilter()">è§£é™¤</button>

<hr>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>

<hr>
<h2>å•†å“ä¸€è¦§</h2>
<ul id="productList"></ul>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
<div class="modalContent">
  <h3>å•†å“ç™»éŒ² / ç·¨é›†</h3>
  <p id="modalBarcode"></p>

  <input id="modalName" placeholder="å•†å“å">
  <input id="modalMaker" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼">

  <select id="modalCategory"></select>
  <button onclick="promptNewCategory()">ï¼‹ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>

  <input id="modalQty" type="number" value="1" min="1">
  <input id="modalPrice" type="number" placeholder="ä»•å…¥ä¾¡æ ¼">
  <input id="modalRetail" type="number" placeholder="ä¸Šä»£">

  <button onclick="submitModal('in')">ä»•å…¥</button>
  <button onclick="submitModal('out')">è²©å£²</button>
  <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
</div>
</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaFkgFPGtYN0GJdo-20mRHJqLLOfsaAFI",
  authDomain: "inventory-mvpcc.firebaseapp.com",
  projectId: "inventory-mvpcc"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentBarcode = "";
let currentFilter = { maker:"", category:"" };
let categories = [];

/* ===== èªè¨¼ ===== */
function login(){
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e=>loginMsg.textContent=e.message);
}
function signup(){
  auth.createUserWithEmailAndPassword(email.value, password.value)
    .catch(e=>loginMsg.textContent=e.message);
}
function logout(){ auth.signOut(); }

/* ===== ã‚«ãƒ†ã‚´ãƒª ===== */
async function loadCategories(){
  const snap = await db.collection("categories").orderBy("name").get();
  categories = snap.docs.map(d=>d.data().name);

  // ç™»éŒ²ç”¨
  modalCategory.innerHTML="";
  categories.forEach(c=>modalCategory.innerHTML+=`<option>${c}</option>`);
  modalCategory.innerHTML+=`<option value="__new__">ï¼‹æ–°è¦</option>`;

  // æ¤œç´¢ç”¨
  filterCategory.innerHTML="<option value=''>ã™ã¹ã¦</option>";
  categories.forEach(c=>filterCategory.innerHTML+=`<option>${c}</option>`);
}

function promptNewCategory(){
  const name = prompt("ã‚«ãƒ†ã‚´ãƒªå");
  if(!name) return;
  db.collection("categories").add({name}).then(loadCategories);
}

/* ===== å•†å“ ===== */
async function ensureProduct(code){
  const ref=db.collection("products").doc(code);
  const snap=await ref.get();
  if(!snap.exists){
    await ref.set({
      barcode:code,
      name:"æœªè¨­å®š",
      manufacturer:"",
      category:"",
      stock:0,
      averageCost:0,
      latestPrice:0,
      retailPrice:0,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

function openModal(code){
  currentBarcode=code;
  modalBarcode.textContent="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: "+code;
  modal.style.display="flex";

  db.collection("products").doc(code).get().then(s=>{
    const p=s.data();
    modalName.value=p.name;
    modalMaker.value=p.manufacturer;
    modalQty.value=1;
    modalPrice.value=p.latestPrice||0;
    modalRetail.value=p.retailPrice||0;
    loadCategories().then(()=>modalCategory.value=p.category||"");
  });
}
function closeModal(){ modal.style.display="none"; }

async function submitModal(type){
  let category=modalCategory.value;
  if(category==="__new__"){ promptNewCategory(); return; }

  const ref=db.collection("products").doc(currentBarcode);
  const snap=await ref.get();
  let p=snap.data();
  let qty=Number(modalQty.value);

  if(type==="in"){
    p.averageCost=((p.averageCost*p.stock)+(modalPrice.value*qty))/(p.stock+qty);
    p.stock+=qty;
    p.latestPrice=Number(modalPrice.value);
  }else{
    if(p.stock<qty) return alert("åœ¨åº«ä¸è¶³");
    p.stock-=qty;
  }

  await ref.update({
    name:modalName.value,
    manufacturer:modalMaker.value,
    category,
    stock:p.stock,
    averageCost:p.averageCost,
    latestPrice:p.latestPrice,
    retailPrice:Number(modalRetail.value),
    updatedAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  closeModal();
  loadProducts();
}

/* ===== ä¸€è¦§ ===== */
async function loadProducts(){
  productList.innerHTML="";
  const snap=await db.collection("products").orderBy("barcode").get();
  snap.forEach(d=>{
    const p=d.data();
    if(currentFilter.maker && p.manufacturer!==currentFilter.maker) return;
    if(currentFilter.category && p.category!==currentFilter.category) return;

    const li=document.createElement("li");
    li.className="product";
    li.innerHTML=`
      ${p.name}ï¼ˆ${p.category}ï¼‰<br>
      åœ¨åº«:${p.stock}<br>
      <button onclick="openModal('${p.barcode}')">ç·¨é›†</button>
    `;
    productList.appendChild(li);
  });
}

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ ===== */
function applyFilter(){
  currentFilter.maker=filterMaker.value.trim();
  currentFilter.category=filterCategory.value;
  loadProducts();
}
function clearFilter(){
  filterMaker.value="";
  filterCategory.value="";
  currentFilter={maker:"",category:""};
  loadProducts();
}

/* ===== CSV ===== */
async function exportCSV(){
  const snap=await db.collection("products").get();
  let csv="barcode,name,manufacturer,category,stock\n";
  snap.forEach(d=>{
    const p=d.data();
    csv+=`${p.barcode},${p.name},${p.manufacturer},${p.category},${p.stock}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="inventory.csv";
  a.click();
}

/* ===== ã‚¹ã‚­ãƒ£ãƒ³ ===== */
scanBtn.onclick=()=>{
  Quagga.init({
    inputStream:{type:"LiveStream",target:"#scanner",constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },()=>Quagga.start());

  Quagga.onDetected(async d=>{
    const code=d.codeResult.code;
    Quagga.stop();
    result.textContent=code;
    await ensureProduct(code);
    openModal(code);
  });
};

function manualBarcodeSet(){
  const code=manualBarcode.value.trim();
  if(!code) return;
  manualBarcode.value="";
  ensureProduct(code).then(()=>openModal(code));
}

auth.onAuthStateChanged(u=>{
  if(u){ loginDiv.classList.add("hidden"); appDiv.classList.remove("hidden"); loadCategories(); loadProducts(); }
});
</script>
</body>
</html>
